server {
    listen 80;
    server_name _;

    # Docker embedded DNS server. Using a variable in proxy_pass forces
    # runtime re-resolution so nginx doesn't cache a stale container IP.
    resolver 127.0.0.11 valid=10s ipv6=off;

    # -------- Superset UI --------
    location / {
        set $superset_upstream mvp-superset:8088;
        proxy_pass http://$superset_upstream/;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # -------- Apicurio Schema Registry (oracle-esw group) --------
    # Kafka UI's Schema Registry integration does not support Apicurio group selection.
    # Apicurio supports group selection via the X-Registry-GroupId header, so we proxy
    # the Confluent-compatible API and inject that header.
    location /schema-registry/oracle-esw/ {
        proxy_pass http://apicurio:8080/apis/ccompat/v7/;

        proxy_set_header X-Registry-GroupId oracle-esw;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
    }

    # -------- Phi-3 Chat UI + /chat API --------
    # Your FastAPI/uvicorn app is on the HOST at http://localhost:8001
    # nginx reaches it via host.docker.internal:8001
    location /phi3/ {
        proxy_pass http://host.docker.internal:8001/;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
